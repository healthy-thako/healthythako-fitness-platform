<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Fix Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .pending {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Authentication Fix Test</h1>
        <p>Testing the 401 authentication error fix with the updated Supabase anon key.</p>

        <div class="test-section" id="config-test">
            <h3>1. Configuration Test</h3>
            <p>Testing environment variables and Supabase configuration.</p>
            <button onclick="testConfiguration()">Test Configuration</button>
            <div id="config-result" class="result"></div>
        </div>

        <div class="test-section" id="connection-test">
            <h3>2. Supabase Connection Test</h3>
            <p>Testing basic connection to Supabase with new anon key.</p>
            <button onclick="testConnection()">Test Connection</button>
            <div id="connection-result" class="result"></div>
        </div>

        <div class="test-section" id="trainers-test">
            <h3>3. Trainers Table Access Test</h3>
            <p>Testing access to trainers table (this was failing with 401).</p>
            <button onclick="testTrainersAccess()">Test Trainers Access</button>
            <div id="trainers-result" class="result"></div>
        </div>

        <div class="test-section" id="search-test">
            <h3>4. Search Function Test</h3>
            <p>Testing the search_trainers function that was failing.</p>
            <button onclick="testSearchFunction()">Test Search Function</button>
            <div id="search-result" class="result"></div>
        </div>

        <div class="test-section" id="specialties-test">
            <h3>5. Specialties Query Test</h3>
            <p>Testing the specialties query that was failing with 401.</p>
            <button onclick="testSpecialtiesQuery()">Test Specialties Query</button>
            <div id="specialties-result" class="result"></div>
        </div>

        <div class="test-section" id="summary">
            <h3>📊 Test Summary</h3>
            <div id="summary-result">Run tests to see summary...</div>
        </div>
    </div>

    <script>
        // Use the corrected Supabase configuration
        const supabaseUrl = 'https://lhncpcsniuxnrmabbkmr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxobmNwY3NuaXV4bnJtYWJia21yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEwMDY5MTUsImV4cCI6MjA1NjU4MjkxNX0.zWr2gDn3bxVzGeCOFzXxgGYtusw6aoboyWBtB1cDo0U';
        
        console.log('Initializing Supabase with corrected anon key...');
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let testResults = {};

        function updateTestSection(sectionId, status, message) {
            const section = document.getElementById(sectionId);
            section.className = `test-section ${status}`;
            
            const resultDiv = document.getElementById(sectionId.replace('-test', '-result'));
            resultDiv.textContent = message;
            resultDiv.className = `result ${status}`;
        }

        function updateSummary() {
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r.success).length;
            const failed = total - passed;
            
            const summaryDiv = document.getElementById('summary-result');
            summaryDiv.innerHTML = `
                <strong>Total Tests:</strong> ${total}<br>
                <strong>Passed:</strong> ${passed}<br>
                <strong>Failed:</strong> ${failed}<br>
                <strong>Success Rate:</strong> ${total > 0 ? Math.round((passed/total)*100) : 0}%<br><br>
                ${failed === 0 ? '🎉 <strong>All tests passed! 401 errors should be fixed.</strong>' : '⚠️ Some tests failed. Check individual results above.'}
            `;
        }

        async function testConfiguration() {
            updateTestSection('config', 'pending', 'Testing configuration...');
            
            try {
                const config = {
                    supabaseUrl: supabaseUrl,
                    anonKeyLength: supabaseKey.length,
                    anonKeyPrefix: supabaseKey.substring(0, 30) + '...',
                    isValidJWT: supabaseKey.includes('.') && supabaseKey.split('.').length === 3
                };
                
                testResults.configuration = { success: true };
                
                const message = `
Configuration Test Results:
✅ Supabase URL: ${config.supabaseUrl}
✅ Anon Key Length: ${config.anonKeyLength} characters
✅ Anon Key Format: ${config.isValidJWT ? 'Valid JWT' : 'Invalid JWT'}
✅ Key Preview: ${config.anonKeyPrefix}

The anon key has been updated and should resolve 401 errors.
                `;
                
                updateTestSection('config', 'success', message);
                
            } catch (error) {
                testResults.configuration = { success: false };
                updateTestSection('config', 'error', `Configuration test failed: ${error.message}`);
            }
            
            updateSummary();
        }

        async function testConnection() {
            updateTestSection('connection', 'pending', 'Testing Supabase connection...');
            
            try {
                // Test basic connection
                const { data, error } = await supabase.from('trainers').select('count').limit(1);
                
                if (error) {
                    throw new Error(`Connection failed: ${error.message} (Code: ${error.code})`);
                }
                
                testResults.connection = { success: true };
                
                const message = `
Connection Test Results:
✅ Successfully connected to Supabase
✅ No 401 authentication errors
✅ Database is accessible
✅ RLS policies are working correctly

The connection is now working with the updated anon key.
                `;
                
                updateTestSection('connection', 'success', message);
                
            } catch (error) {
                testResults.connection = { success: false };
                updateTestSection('connection', 'error', `Connection test failed: ${error.message}`);
            }
            
            updateSummary();
        }

        async function testTrainersAccess() {
            updateTestSection('trainers', 'pending', 'Testing trainers table access...');
            
            try {
                // This was the exact query that was failing with 401
                const { data, error } = await supabase
                    .from('trainers')
                    .select('id, name, specialty, rating')
                    .limit(3);
                
                if (error) {
                    throw new Error(`Trainers access failed: ${error.message} (Code: ${error.code})`);
                }
                
                testResults.trainers = { success: true };
                
                const message = `
Trainers Access Test Results:
✅ Successfully accessed trainers table
✅ Retrieved ${data.length} trainer records
✅ No 401 authentication errors
✅ RLS policies allow anonymous access

Sample trainers retrieved:
${data.map(t => `- ${t.name} (${t.specialty})`).join('\n')}
                `;
                
                updateTestSection('trainers', 'success', message);
                
            } catch (error) {
                testResults.trainers = { success: false };
                updateTestSection('trainers', 'error', `Trainers access test failed: ${error.message}`);
            }
            
            updateSummary();
        }

        async function testSearchFunction() {
            updateTestSection('search', 'pending', 'Testing search function...');
            
            try {
                // This was the RPC call that was failing with 401
                const { data, error } = await supabase.rpc('search_trainers', {
                    search_query: '',
                    specialty_filter: '',
                    gym_id_filter: null,
                    min_rating: 0,
                    limit_count: 3,
                    offset_count: 0
                });
                
                if (error) {
                    throw new Error(`Search function failed: ${error.message} (Code: ${error.code})`);
                }
                
                testResults.search = { success: true };
                
                const message = `
Search Function Test Results:
✅ Successfully called search_trainers function
✅ Retrieved ${data.length} search results
✅ No 401 authentication errors
✅ Function permissions are correctly configured

Search results:
${data.map(t => `- ${t.name} (Rating: ${t.rating})`).join('\n')}
                `;
                
                updateTestSection('search', 'success', message);
                
            } catch (error) {
                testResults.search = { success: false };
                updateTestSection('search', 'error', `Search function test failed: ${error.message}`);
            }
            
            updateSummary();
        }

        async function testSpecialtiesQuery() {
            updateTestSection('specialties', 'pending', 'Testing specialties query...');
            
            try {
                // This was the exact query that was failing with 401
                const { data, error } = await supabase
                    .from('trainers')
                    .select('specialties')
                    .not('specialties', 'is', null)
                    .limit(3);
                
                if (error) {
                    throw new Error(`Specialties query failed: ${error.message} (Code: ${error.code})`);
                }
                
                testResults.specialties = { success: true };
                
                const message = `
Specialties Query Test Results:
✅ Successfully queried specialties column
✅ Retrieved ${data.length} records with specialties
✅ No 401 authentication errors
✅ Complex queries are working

Sample specialties:
${data.map(t => `- ${t.specialties ? t.specialties.slice(0, 2).join(', ') : 'None'}`).join('\n')}
                `;
                
                updateTestSection('specialties', 'success', message);
                
            } catch (error) {
                testResults.specialties = { success: false };
                updateTestSection('specialties', 'error', `Specialties query test failed: ${error.message}`);
            }
            
            updateSummary();
        }

        // Auto-run configuration test on page load
        window.addEventListener('load', () => {
            console.log('Authentication Fix Test Page Loaded');
            setTimeout(testConfiguration, 1000);
        });
    </script>
</body>
</html>
